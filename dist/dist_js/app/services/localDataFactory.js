"use strict";angular.module("app.services").factory("localDataFactory",["$pouchDB","$q","$log","ImportFactory","$ionicPlatform","$timeout",function(e,t,n,i,a,o){var r={},c="https://mymarsi.cloudant.com/marsi-real-world-v3";r.currentPerson={_id:"Kim",name:"Kim"},r.isReady=!1,r.processingPromise=null,r.selectedInspectionID=null,r.selectedInspection={},r.allInspectionIDs={},r.allUnits={data:{}},r.selectedVisit={},r.selectedTemplate={},r.showSections={data:{}},r.activeSync={state:!0},r.withoutTemplate=void 0,r.getAttachment=e.getAttachment,r.currentInspectionTemplateOptions=i.currentInspectionTemplateOptions;var s=function(){n.info("Device should be ready, setting up database"),e.setDatabase("mymarsi-beta-visits-v2-1"),r.activeSync.state=!1,e.sync(c).on("change",function(e){"pull"===e.direction&&(n.info("Got new data from cloudant so replacing all unit structure"),r.getAllUnits())}).on("paused",function(e){n.info("Cloud changes sync is waiting for new data"),r.getAllUnits()}).on("active",function(){r.activeSync.state=!0,n.info("Cloud changes sync is actively exchanging new data")}).on("denied",function(e){n.error("a document failed to replicate (e.g. due to permissions)"),n.error(e)}).on("complete",function(e){n.info("sync complete"),r.getAllUnits()}).on("error",function(e){n.error("sync error"),n.error(e)})};r.removeTemplateSectionFromVisit=function(e,t){var n=r.selectedVisit.data[e].data[t],i=r.selectedTemplate.data[e].data[t];angular.forEach(n,function(e,t){angular.equals(e,i[t])&&delete n[t]}),angular.forEach(n.typesConditions,function(e,t){angular.equals(e,i.typesConditions[t])&&delete n.typesConditions[t]})},r.getAllUnits=function(){var t="getUnits/all-units-by-id";return e.query(t,!0).then(function(e){r.allUnits.data={},angular.forEach(e.rows,function(e){var t=e.doc;r.allUnits.data[t._id]=t}),r.activeSync.state=!1})},r.getQueryStubs=function(i,a){var o=t.defer();return e.query(a,!1,i).then(function(e){var t={};angular.forEach(e.rows,function(e){t[e.id]={_id:e.id,name:e.value}}),o.resolve(t)})["catch"](function(e){n.error(e),o.reject(e)}),o.promise},r.getAllDocumentIDs=function(){return e.getAll(!1).then(function(e){e.rows.length&&(r.allInspectionIDs={},angular.forEach(e.rows,function(e){r.allInspectionIDs[e.id]={_id:e.id}}))})};var u=function(e){n.error(e),r.selectedInspectionID=null,r.isReady=!1,r.processingPromise.reject(e)};r.getInspectionData=function(i,a){return i===r.selectedInspectionID&&r.withoutTemplate===a?r.isReady?t.when(r.selectedInspection):r.processingPromise.promise:(r.withoutTemplate=a,r.isReady=!1,r.processingPromise=t.defer(),r.selectedInspection={},r.selectedInspectionID=i,e.get({ok:!0,id:i}).then(function(t){n.info("Success getting sections from local db"),t.templateID?e.get({ok:!0,id:t.templateID}).then(function(n){a?r.selectedInspection={data:{}}:r.selectedInspection=n,r.selectedTemplate=angular.copy(n),angular.merge(r.selectedInspection,t);var o="getInspectionVisits/visit-data-by-inspection-id";e.query(o,!0,i).then(function(e){angular.forEach(e.rows,function(e){angular.merge(r.selectedInspection.data,e.doc.data)}),r.isReady=!0,r.showSections.data={},r.processingPromise.resolve(r.selectedInspection)})["catch"](u)})["catch"](u):u("No inspection template")})["catch"](u),r.processingPromise.promise)},r.getVisitData=function(i){var a=t.defer();return e.get({ok:!0,id:i}).then(function(e){a.resolve(e)})["catch"](function(e){n.error(e),a.reject(e)}),a.promise},r.createNewVisit=function(e,t){var n=t._id,i=new Date,a=i.getTime(),o=i.toString(),c="Visit "+o,s=e+"/"+t.name+"/"+c;return angular.extend(r.selectedVisit,{_id:s,createdAt:a,name:c,type:"Visit",inspectionID:n,userID:r.currentPerson._id,userName:r.currentPerson.name,data:{}}),r.getInspectionData(t._id)},r.saveVisitData=function(e,t,n){r.selectedVisit.data[e]||(r.selectedVisit.data[e]={}),r.selectedVisit.data[e].data||(r.selectedVisit.data[e].data={}),r.selectedVisit.data[e].data[t]=angular.copy(n),r.removeTemplateSectionFromVisit(e,t),r.selectedVisit.data[e].data[t].markSectionComplete=!0,r.saveData(r.selectedVisit)},r.saveData=function(t){e.save(t).then(function(){n.info("Success saving change to db")})["catch"](function(i){409===i.status?e.retryUntilWritten(t):n.error(i)})};var l=function(t){return e.get({ok:!0,id:r.selectedVisit._id}).then(function(e){return e._attachments?(r.selectedVisit._attachments=e._attachments,e._attachments):void 0})};return r.saveAttachment=function(t,i){return window.blobUtil.dataURLToBlob(t.src).then(function(a){return e.get({ok:!0,id:r.selectedVisit._id}).then(function(n){return e.putAttachment(n._id,t._id,n._rev,a,i).then(l)})["catch"](function(o){if(404===o.status)return e.save(r.selectedVisit).then(function(n){return e.putAttachment(r.selectedVisit._id,t._id,n.rev,a,i).then(l)});throw n.error(o),o})}).then(function(){return n.info("Success saving attachment to db"),1})["catch"](function(e){n.error(e)})},r.createNewUnit=function(t){var i=t.name.trim().toUpperCase();return e.get({ok:!0,id:i}).then(function(e){return n.error("Tried to create new unit with non-unique name"),e})["catch"](function(a){if(404===a.status){var o={_id:i,name:t.name,type:"Unit",unitTemplate:t.unitTemplate};return e.save(o).then(function(){return n.info("Created new unit, so replacing all unit structure"),r.getAllUnits(),i})["catch"](function(e){n.error(e)})}n.error(a)})},r.createNewInspection=function(t,a){var o={_id:t._id+"/Inspection "+(new Date).getTime(),propertyID:t._id,propertyName:t.name,name:a,type:"Inspection",checklistVersion:i.currentChecklistDisplayVersion,templateID:t.unitTemplate._id};return e.save(o).then(function(){n.info("Created new inspection")})["catch"](function(e){n.error(e)})},r.syncData=function(){return t.resolve(!0)},window.localStorage.ionicView?a.ready(s):o(s,0),r}]);