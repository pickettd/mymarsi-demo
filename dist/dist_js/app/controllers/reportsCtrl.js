"use strict";angular.module("app.controllers").controller("reportsCtrl",["$scope","localDataFactory","$log","$location","$ionicScrollDelegate","$timeout","$q",function(t,o,e,r,n,i,s){t.reports={},t.reports.allUnits=o.allUnits,t.reports.inspectionStubs=null,t.reports.visitStubs=null,t.reports.visitData={ready:!1,data:{}},t.reports.fullInspection={data:{}},t.reports.itemsByCondition={data:{}},t.reports.countOfConditionDataPoints=0,t.reports.countOfHospitalityDataPoints=0,t.reports.perRoomCountOfConditionDataPoints={},t.reports.sumOfHospitalityPoints=0,t.reports.perRoomSumOfConditionPoints={},t.reports.perRoomAvgOfConditionPoints={},t.reports.showImages={},t.reports.visibleImages={data:{}},t.reports.currentInspectionTemplateOptions=o.currentInspectionTemplateOptions,t.reports.newInspectionName="",t.reports.newUnitInspectionName="",t.reports.newUnit={},t.reports.createUnit=function(){return t.reports.newUnit.unitTemplate?t.reports.newUnit.name&&""!==t.reports.newUnit.name.trim()?t.reports.newUnitInspectionName&&""!==t.reports.newUnitInspectionName.trim()?void o.createNewUnit(t.reports.newUnit).then(function(e){return e&&e._id?void alert("Unit name must be unique"):(t.reports.showNewUnit=!1,t.reports.newUnit._id=e,o.createNewInspection(t.reports.newUnit,t.reports.newUnitInspectionName).then(function(){delete t.reports.newUnit.name,delete t.reports.newUnit.unitTemplate,t.reports.newUnitInspectionName=""}),void 0)}):void alert("New Unit Inspection name cannot be empty"):void alert("Unit name cannot be empty"):void alert("You must select the # of beds/baths")},t.reports.createInspection=function(){return t.reports.newInspectionName&&""!==t.reports.newInspectionName.trim()?void o.createNewInspection(t.reports.selectedUnit,t.reports.newInspectionName).then(function(){t.reports.getInspectionStubs(t.reports.selectedUnit._id),t.reports.showNewInspection=!1,t.reports.newInspectionName=""}):void alert("Inspection name cannot be empty")};var a=function(){t.reports.itemsByCondition.data={},t.reports.countOfConditionDataPoints=0,t.reports.countOfHospitalityDataPoints=0,t.reports.perRoomCountOfConditionDataPoints={},t.reports.sumOfHospitalityPoints=0,t.reports.perRoomSumOfConditionPoints={},t.reports.perRoomAvgOfConditionPoints={}},p=function(){t.reports.showByRoom=!1,t.reports.showByCondition=!1,t.reports.hideSection={},t.reports.hideRoom={},t.reports.showConditionDetails={},t.reports.showImages={},t.reports.visibleImages.data={}};t.reports.defaultPrintView=function(){p(),angular.forEach(t.reports.fullInspection.data,function(o,e){angular.forEach(o.data,function(o,r){o.naChoice&&(t.reports.hideSection[e]||(t.reports.hideSection[e]={}),t.reports.hideSection[e][r]=!0)})}),t.reports.showByRoom=!0,t.reports.showByCondition=!0},t.reports.scrollToID=function(t){r.hash(t),n.anchorScroll()},t.reports.scrollToSection=function(o,e){t.reports.showByRoom=!0,t.reports.hideRoom[o]&&(t.reports.hideRoom[o]=!1),t.reports.hideSection[o]&&t.reports.hideSection[o][e]&&(t.reports.hideSection[o][e]=!1),t.reports.scrollToID(e)},t.reports.scrollToCondition=function(o){t.reports.showByCondition=!0,t.reports.scrollToID(o+"Section")},t.reports.scrollToConditionTable=function(){t.reports.showByCondition=!1,t.reports.showByRoom=!1,t.reports.scrollToID("conditionTable")};var c=function(o,e){t.reports.showImages[o]||(t.reports.showImages[o]={}),t.reports.showImages[o][e]=!1,t.reports.visibleImages.data[o]&&t.reports.visibleImages.data[o][e]&&(t.reports.visibleImages.data[o][e]={})},l=function(r,n,a){var p=[];return t.reports.showImages[r]||(t.reports.showImages[r]={}),angular.forEach(a,function(a,c){t.reports.visibleImages.data[r]||(t.reports.visibleImages.data[r]={}),t.reports.visibleImages.data[r][n]||(t.reports.visibleImages.data[r][n]={}),t.reports.visibleImages.data[r][n][c]||p.push(o.getAttachment(a,c).then(function(o){var a=s.defer(),p=window.loadImage(o,function(o){var s={_id:c,src:o.toDataURL()};return i(function(){return t.reports.visibleImages.data[r][n][c]=s,e.info("Loaded image data"),a.resolve(),s})},{maxWidth:400,orientation:!0});return p||(e.error("No image loading library"),a.reject("No image loading library")),a.promise})["catch"](function(t){e.error(t)}))}),t.reports.showImages[r][n]=!0,p};t.reports.closeAllImageSections=function(){angular.forEach(t.reports.fullInspection.data,function(t,o){angular.forEach(t.data,function(t,e){t.images&&c(o,e)})})},t.reports.openAllImageSections=function(){var o=0,r=[];angular.forEach(t.reports.fullInspection.data,function(t,e){angular.forEach(t.data,function(t,n){if(t.images){angular.forEach(t.images,function(){o++});var i=l(e,n,t.images);angular.forEach(i,function(t){r.push(t)})}})}),e.info("Number of total images: "+o),s.all(r).then(function(){e.info("Completed all images"),alert("Finished loading and scaling all images")})},t.reports.toggleImageSection=function(o,e,r){t.reports.showImages[o]||(t.reports.showImages[o]={}),t.reports.showImages[o][e]?c(o,e):(t.reports.showImages[o][e]=!1,l(o,e,r))},t.reports.getInspectionStubs=function(e){t.reports.inspectionStubs={};var r="getInspections/inspection-data-by-unit-id";o.getQueryStubs(e,r).then(function(o){t.reports.inspectionStubs=o})},t.reports.getVisitStubs=function(e){t.reports.fullReportReady=!1,t.reports.visitStubs={};var r="getInspectionVisits/visit-data-by-inspection-id";o.getQueryStubs(e,r).then(function(o){t.reports.visitStubs=o})},t.reports.getVisitData=function(e){t.reports.visitData.ready=!1,t.reports.visitData.data={},o.getVisitData(e).then(function(o){t.reports.visitData.data=angular.toJson(o,!0),t.reports.visitData.ready=!0})},t.reports.getOptionTemplateFromID=function(o,e){for(var r=0;r<t.reports.typesConditions[o].options.length;r++)for(var n=t.reports.typesConditions[o].options[r],i=0;i<n.length;i++){var s=n[i];if(s.optionID===e)return s}},t.reports.getReportInspection=function(r){t.reports.fullReportReady=!1,p(),a(),o.getInspectionData(r,!0).then(function(){e.info("Finished getting inspection data for full report"),t.reports.selectedPropertyName=o.selectedInspection.propertyName,o.selectedTemplate.inspectionWorkTrackingConditions&&(t.reports.inspectionWorkTrackingConditions=o.selectedTemplate.inspectionWorkTrackingConditions,angular.forEach(o.selectedTemplate.inspectionWorkTrackingConditions.data,function(o,e){t.reports.itemsByCondition.data[e]||(t.reports.itemsByCondition.data[e]=[])})),o.selectedTemplate.typesConditions&&(t.reports.typesConditions=o.selectedTemplate.typesConditions),o.selectedTemplate.trades&&(t.reports.trades=o.selectedTemplate.trades);var r=o.selectedTemplate.checklistVersion;r||(r="v1"),t.reports.checklistVersion=r,t.reports.fullInspection=angular.copy(o.selectedInspection),t.reports.selectedTemplate=o.selectedTemplate,angular.forEach(t.reports.fullInspection.data,function(o,e){angular.forEach(o.data,function(o,r){if(o.naChoice&&(t.reports.hideSection[e]||(t.reports.hideSection[e]={}),t.reports.hideSection[e][r]=!0),o.hospitalityRating){var n=parseInt(o.hospitalityRating);t.reports.countOfHospitalityDataPoints++,t.reports.sumOfHospitalityPoints+=n,t.reports.perRoomCountOfConditionDataPoints[e]?(t.reports.perRoomCountOfConditionDataPoints[e]++,t.reports.perRoomSumOfConditionPoints[e]+=n,t.reports.perRoomAvgOfConditionPoints[e]=t.reports.perRoomSumOfConditionPoints[e]/t.reports.perRoomCountOfConditionDataPoints[e]):(t.reports.perRoomCountOfConditionDataPoints[e]=1,t.reports.perRoomSumOfConditionPoints[e]=n,t.reports.perRoomAvgOfConditionPoints[e]=n)}if(o.inspectionWorkTrackingConditions){var i=o.inspectionWorkTrackingConditions.selection,s={roomKey:e,sectionKey:r,data:o};t.reports.itemsByCondition.data[i].push(s),t.reports.countOfConditionDataPoints++}})}),e.info("Full report is ready"),t.reports.fullReportReady=!0})}}]);