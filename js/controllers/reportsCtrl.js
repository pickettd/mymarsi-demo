"use strict";angular.module("app.controllers").controller("reportsCtrl",["$scope","localDataFactory","$log","$location","$ionicScrollDelegate","$timeout","$q",function(t,o,e,n,r,s,i){t.reports={},t.reports.fullReportReady=!0,t.reports.allUnits=o.allUnits,t.reports.inspectionStubs=null,t.reports.visitStubs=null,t.reports.visitData={ready:!1,data:{}},t.reports.fullInspection={data:{}},t.reports.itemsByCondition={data:{}},t.reports.countOfConditionDataPoints=0,t.reports.countOfHospitalityDataPoints=0,t.reports.perRoomCountOfConditionDataPoints={},t.reports.sumOfHospitalityPoints=0,t.reports.perRoomSumOfConditionPoints={},t.reports.perRoomAvgOfConditionPoints={},t.reports.showImages={},t.reports.visibleImages={data:{}},t.reports.currentInspectionTemplateOptions=o.currentInspectionTemplateOptions,t.reports.newInspectionName="",t.reports.newUnitInspectionName="",t.reports.newUnit={},t.reports.createUnit=function(){return t.reports.newUnit.unitTemplate?t.reports.newUnit.name&&""!==t.reports.newUnit.name.trim()?t.reports.newUnitInspectionName&&""!==t.reports.newUnitInspectionName.trim()?void o.createNewUnit(t.reports.newUnit).then(function(e){return e&&e._id?void alert("Unit name must be unique"):(t.reports.showNewUnit=!1,t.reports.newUnit._id=e,o.createNewInspection(t.reports.newUnit,t.reports.newUnitInspectionName).then(function(){delete t.reports.newUnit.name,delete t.reports.newUnit.unitTemplate,t.reports.newUnitInspectionName=""}),void 0)}):void alert("New Unit Inspection name cannot be empty"):void alert("Unit name cannot be empty"):void alert("You must select the # of beds/baths")},t.reports.createInspection=function(){return t.reports.newInspectionName&&""!==t.reports.newInspectionName.trim()?void o.createNewInspection(t.reports.selectedUnit,t.reports.newInspectionName).then(function(){t.reports.getInspectionStubs(t.reports.selectedUnit._id),t.reports.showNewInspection=!1,t.reports.newInspectionName=""}):void alert("Inspection name cannot be empty")};var a=function(){t.reports.itemsByCondition.data={},t.reports.countOfConditionDataPoints=0,t.reports.countOfHospitalityDataPoints=0,t.reports.perRoomCountOfConditionDataPoints={},t.reports.sumOfHospitalityPoints=0,t.reports.perRoomSumOfConditionPoints={},t.reports.perRoomAvgOfConditionPoints={}},p=function(){t.reports.showByRoom=!1,t.reports.showByCondition=!1,t.reports.hideSection={},t.reports.hideRoom={},t.reports.showConditionDetails={},t.reports.showImages={},t.reports.visibleImages.data={}};t.reports.defaultPrintView=function(){p(),angular.forEach(t.reports.fullInspection.data,function(o,e){angular.forEach(o.data,function(o,n){o.naChoice&&(t.reports.hideSection[e]||(t.reports.hideSection[e]={}),t.reports.hideSection[e][n]=!0)})}),t.reports.showByRoom=!0,t.reports.showByCondition=!0},t.reports.scrollToID=function(t){n.hash(t),r.anchorScroll()},t.reports.scrollToSection=function(o,e){t.reports.showByRoom=!0,t.reports.hideRoom[o]&&(t.reports.hideRoom[o]=!1),t.reports.hideSection[o]&&t.reports.hideSection[o][e]&&(t.reports.hideSection[o][e]=!1),t.reports.scrollToID(e)},t.reports.scrollToCondition=function(o){t.reports.showByCondition=!0,t.reports.scrollToID(o+"Section")},t.reports.scrollToConditionTable=function(){t.reports.showByCondition=!1,t.reports.showByRoom=!1,t.reports.scrollToID("conditionTable")};var c=function(o,e){t.reports.showImages[o]||(t.reports.showImages[o]={}),t.reports.showImages[o][e]=!1,t.reports.visibleImages.data[o]&&t.reports.visibleImages.data[o][e]&&(t.reports.visibleImages.data[o][e]={})},l=function(o,e,n){var r=[];return t.reports.showImages[o]||(t.reports.showImages[o]={}),angular.forEach(n,function(n,r){t.reports.visibleImages.data[o]||(t.reports.visibleImages.data[o]={}),t.reports.visibleImages.data[o][e]||(t.reports.visibleImages.data[o][e]={}),t.reports.visibleImages.data[o][e][r]||(t.reports.visibleImages.data[o][e][r]=n)}),t.reports.showImages[o][e]=!0,r};t.reports.closeAllImageSections=function(){angular.forEach(t.reports.fullInspection.data,function(t,o){angular.forEach(t.data,function(t,e){t.images&&c(o,e)})})},t.reports.openAllImageSections=function(){var o=0,n=[];angular.forEach(t.reports.fullInspection.data,function(t,e){angular.forEach(t.data,function(t,r){if(t.images){angular.forEach(t.images,function(){o++});var s=l(e,r,t.images);angular.forEach(s,function(t){n.push(t)})}})}),e.info("Number of total images: "+o),i.all(n).then(function(){e.info("Completed all images"),alert("Finished loading and scaling all images")})},t.reports.toggleImageSection=function(o,e,n){t.reports.showImages[o]||(t.reports.showImages[o]={}),t.reports.showImages[o][e]?c(o,e):(t.reports.showImages[o][e]=!1,l(o,e,n))},t.reports.getInspectionStubs=function(e){t.reports.inspectionStubs={};var n="getInspections/inspection-data-by-unit-id";o.getQueryStubs(e,n).then(function(o){t.reports.inspectionStubs=o})},t.reports.getOptionTemplateFromID=function(o,e){for(var n=0;n<t.reports.typesConditions[o].options.length;n++)for(var r=t.reports.typesConditions[o].options[n],s=0;s<r.length;s++){var i=r[s];if(i.optionID===e)return i}},t.reports.getReportInspection=function(n){t.reports.fullReportReady=!1;var r=performance.now();p(),a(),o.getInspectionData(n,!0).then(function(){e.info("Finished getting inspection data for full report"),t.reports.selectedPropertyName=o.selectedInspection.propertyName,o.selectedTemplate.inspectionWorkTrackingConditions&&(t.reports.inspectionWorkTrackingConditions=o.selectedTemplate.inspectionWorkTrackingConditions,angular.forEach(o.selectedTemplate.inspectionWorkTrackingConditions.data,function(o,e){t.reports.itemsByCondition.data[e]||(t.reports.itemsByCondition.data[e]=[])})),o.selectedTemplate.typesConditions&&(t.reports.typesConditions=o.selectedTemplate.typesConditions),o.selectedTemplate.trades&&(t.reports.trades=o.selectedTemplate.trades);var n=o.selectedTemplate.checklistVersion;n||(n="v1"),t.reports.checklistVersion=n,t.reports.fullInspection=angular.copy(o.selectedInspection),t.reports.selectedTemplate=o.selectedTemplate,angular.forEach(t.reports.fullInspection.data,function(o,e){angular.forEach(o.data,function(o,n){if(o.naChoice&&(t.reports.hideSection[e]||(t.reports.hideSection[e]={}),t.reports.hideSection[e][n]=!0),o.hospitalityRating){var r=parseInt(o.hospitalityRating);t.reports.countOfHospitalityDataPoints++,t.reports.sumOfHospitalityPoints+=r,t.reports.perRoomCountOfConditionDataPoints[e]?(t.reports.perRoomCountOfConditionDataPoints[e]++,t.reports.perRoomSumOfConditionPoints[e]+=r,t.reports.perRoomAvgOfConditionPoints[e]=t.reports.perRoomSumOfConditionPoints[e]/t.reports.perRoomCountOfConditionDataPoints[e]):(t.reports.perRoomCountOfConditionDataPoints[e]=1,t.reports.perRoomSumOfConditionPoints[e]=r,t.reports.perRoomAvgOfConditionPoints[e]=r)}if(o.inspectionWorkTrackingConditions){var s=o.inspectionWorkTrackingConditions.selection,i={roomKey:e,sectionKey:n,data:o};t.reports.itemsByCondition.data[s].push(i),t.reports.countOfConditionDataPoints++}})}),e.info("Full report is ready"),t.reports.fullReportReady=!0;var s=performance.now();e.info("Call to get full report took "+(s-r)+" milliseconds.")})}}]);