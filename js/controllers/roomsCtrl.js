"use strict";angular.module("app.controllers").controller("roomsCtrl",["$scope","$ionicModal","$log","localDataFactory","$stateParams","$state","$location","$ionicScrollDelegate","$timeout","$q","dropbox",function(o,e,s,m,r,i,t,n,a,c,d){var l=function(){if(o.rooms={},o.rooms.hideTypeConditions={"Year/Make/Model":!0,Warranty:!0},o.rooms.showSections=m.showSections,o.rooms.selectedRoomID=r.roomID,o.rooms[r.roomID]={},o.rooms[r.roomID].newComments={},o.rooms[r.roomID].newImages={},o.rooms[r.roomID].newVideos={},o.rooms[r.roomID].modalSection="",o.rooms[r.roomID].checklistVersion="loading",o.rooms[r.roomID].showTips={},o.rooms.inspectionWorkTrackingConditions={},o.rooms.typesConditions={},o.rooms.trades={},"GENERAL"===r.roomID?o.rooms.showTrade="Electrical":o.rooms.showTrade="Carpentry",m.selectedVisit._id?o.rooms.displayTitle=m.selectedVisit.name:o.rooms.displayTitle="",m.selectedInspection._id&&m.selectedVisit._id){o.rooms[r.roomID].selectedPropertyName=m.selectedInspection.propertyName,o.rooms.displayTitle=m.selectedVisit.name,m.selectedInspection.inspectionWorkTrackingConditions&&(o.rooms.inspectionWorkTrackingConditions=m.selectedInspection.inspectionWorkTrackingConditions),m.selectedInspection.typesConditions&&(o.rooms.typesConditions=m.selectedInspection.typesConditions),m.selectedInspection.trades&&(o.rooms.trades=m.selectedInspection.trades);var c=m.selectedInspection.checklistVersion;c||(c="v1"),o.rooms[r.roomID].checklistVersion=c,o.rooms[r.roomID].sections=m.selectedInspection.data[r.roomID].data}else s.info("In room controller but no inspection selected, should be redirected");o.$on("$ionicView.beforeEnter",function(){angular.equals(m.selectedVisit,{})&&i.go("home",{},{reload:!0}),l()}),o.$on("$ionicView.leave",function(){o.$destroy()}),o.rooms.setSectionProperty=function(e,s,i){e[s]=i;var t={};t[s]=i,m.saveVisitDataByProperties(r.roomID,e,t),o.rooms[r.roomID].sections[e._id].markSectionComplete=!0},o.rooms.markSectionNA=function(e,s){e.naChoice?e.naChoice=!1:(e.naChoice=!0,o.rooms.showSections.data||(o.rooms.showSections.data={}),o.rooms.showSections.data[r.roomID]=""),s&&(e.naChoice=!0),o.rooms.setSectionProperty(e,"naChoice",e.naChoice)},o.rooms.setTimelineSelection=function(e,s){e.inspectionWorkTrackingConditions.selection=s;var i={inspectionWorkTrackingConditions:{selection:s}};m.saveVisitDataByProperties(r.roomID,e,i),o.rooms[r.roomID].sections[e._id].markSectionComplete=!0},o.rooms.setTypeConditionDetail=function(e,s,i,t,n){"checkboxValue"===t&&(n=!n),e.typesConditions[s]||(e.typesConditions[s]={}),e.typesConditions[s][i]||(e.typesConditions[s][i]={}),e.typesConditions[s][i][t]=n;var a={typesConditions:{}};a.typesConditions[s]={},a.typesConditions[s][i]={},a.typesConditions[s][i][t]=n,m.saveVisitDataByProperties(r.roomID,e,a),o.rooms[r.roomID].sections[e._id].markSectionComplete=!0},o.rooms.toggleSectionVisible=function(e){o.rooms.showSections.data||(o.rooms.showSections.data={}),o.rooms.showSections.data[r.roomID]===e._id?o.rooms.showSections.data[r.roomID]="":(o.rooms.showSections.data[r.roomID]=e._id,t.hash(e._id),n.anchorScroll())},o.rooms.videoError=function(o){s.error(o)},o.rooms.videoConfig={sources:[{}],tracks:[],theme:"lib/videogular-themes-default/videogular.css"};var I=function(e){o.rooms[r.roomID].modalSection=e};o.rooms[r.roomID].fileNameChanged=function(e){var s=e.target;o.rooms[r.roomID].filesItemHandle=s,1===s.files.length&&0===s.files[0].type.indexOf("image/")&&a(function(){var e=new Date,i=e.getTime(),t=o.rooms[r.roomID].modalSection,n=t+i+".jpg";n=n.split("/").join("_");var a=r.roomID;a=a.split("/").join("_");var c=m.selectedInspection.propertyName;c=c.split("/").join("_");var l=m.selectedInspection.name;l=l.split("/").join("_");var I="/"+c+"/"+l+"/"+a;d.upload(n,s.files[0],I),o.rooms[r.roomID].newImages||(o.rooms[r.roomID].newImages={});var D={_id:i,visitID:m.selectedVisit._id,link:"https://www.dropbox.com/home/Apps/myMARSI"+encodeURI(I+"/"+n),src:"",name:n,fullPath:I+"/"+n};o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]=D,o.rooms[r.roomID].addNewImage()})},o.rooms[r.roomID].addNewImage=function(){var e=o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection],s=angular.copy(o.rooms[r.roomID].newImages[e._id]);e.images||(e.images={}),e.images[s._id]=s,o.rooms[r.roomID].newImages[e._id]={};var i={images:{}};i.images[s._id]=s,m.saveVisitDataByProperties(r.roomID,e,i),o.rooms[r.roomID].sections[e._id].markSectionComplete=!0,o.rooms[r.roomID].filesItemHandle.value=""},o.rooms[r.roomID].createComment=function(){var e=o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection],s=angular.copy(o.rooms[r.roomID].newComments[e._id]);o.rooms[r.roomID].comments||(o.rooms[r.roomID].comments={}),e.comments||(e.comments={}),s._id=(new Date).getTime(),e.comments[s._id]=s,o.rooms[r.roomID].newComments[e._id]={};var i={comments:{}};i.comments[s._id]=s,m.saveVisitDataByProperties(r.roomID,e,i),o.rooms[r.roomID].sections[e._id].markSectionComplete=!0},e.fromTemplateUrl("templates/modals/manageComments.html",{scope:o,animation:"slide-in-up",focusFirstInput:!0}).then(function(e){o.rooms[r.roomID].commentsModal=e}),o.rooms[r.roomID].openCommentsModal=function(e){I(e),o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID].commentsModal.show()},e.fromTemplateUrl("templates/modals/manageVideos.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.rooms[r.roomID].videosModal=e}),o.rooms[r.roomID].openVideosModal=function(e){I(e),o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID][o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID][o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID][o.rooms[r.roomID].modalSection].showDelete=!1,o.rooms[r.roomID].videosModal.show()},e.fromTemplateUrl("templates/modals/manageImages.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.rooms[r.roomID].imagesModal=e}),o.rooms[r.roomID].openImagesModal=function(e){I(e),o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]={}),m.selectedInspection.data[r.roomID]&&m.selectedInspection.data[r.roomID].data[o.rooms[r.roomID].modalSection]&&angular.forEach(m.selectedInspection.data[r.roomID].data[o.rooms[r.roomID].modalSection].images,function(e,s){o.rooms[r.roomID][o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID][o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID][o.rooms[r.roomID].modalSection].images||(o.rooms[r.roomID][o.rooms[r.roomID].modalSection].images={}),o.rooms[r.roomID][o.rooms[r.roomID].modalSection].images[s]=e}),o.rooms[r.roomID].imagesModal.show()},o.$on("modal.hidden",function(e){s.info("Closing one of the modals"),o.rooms[r.roomID]&&o.rooms[r.roomID].modalSection&&o.rooms[r.roomID][o.rooms[r.roomID].modalSection]&&delete o.rooms[r.roomID][o.rooms[r.roomID].modalSection].images}),o.$on("$destroy",function(){s.info("Destroying all modals"),o.rooms[r.roomID].imagesModal.remove(),o.rooms[r.roomID].videosModal.remove(),o.rooms[r.roomID].commentsModal.remove()})};l()}]);