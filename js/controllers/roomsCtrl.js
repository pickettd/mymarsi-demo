"use strict";angular.module("app.controllers").controller("roomsCtrl",["$scope","$ionicModal","$log","localDataFactory","$stateParams","$state","$location","$ionicScrollDelegate","$timeout",function(o,m,e,r,s,t,i,n,a){var d=function(){if(o.rooms={},o.rooms.hideTypeConditions={"Year/Make/Model":!0,Warranty:!0},o.rooms.showSections=r.showSections,o.rooms.selectedRoomID=s.roomID,o.rooms[s.roomID]={},o.rooms[s.roomID].newComments={},o.rooms[s.roomID].newImages={},o.rooms[s.roomID].newVideos={},o.rooms[s.roomID].modalSection="",o.rooms[s.roomID].checklistVersion="loading",o.rooms[s.roomID].showTips={},o.rooms.inspectionWorkTrackingConditions={},o.rooms.typesConditions={},o.rooms.trades={},"GENERAL"===s.roomID?o.rooms.showTrade="Electrical":o.rooms.showTrade="Carpentry",r.selectedVisit._id?o.rooms.displayTitle=r.selectedVisit._id:o.rooms.displayTitle="",r.selectedInspection._id&&r.selectedVisit._id){o.rooms[s.roomID].selectedPropertyName=r.selectedInspection.propertyName,o.rooms.displayTitle=r.selectedVisit._id,r.selectedInspection.inspectionWorkTrackingConditions&&(o.rooms.inspectionWorkTrackingConditions=r.selectedInspection.inspectionWorkTrackingConditions),r.selectedInspection.typesConditions&&(o.rooms.typesConditions=r.selectedInspection.typesConditions),r.selectedInspection.trades&&(o.rooms.trades=r.selectedInspection.trades);var c=r.selectedInspection.checklistVersion;c||(c="v1"),o.rooms[s.roomID].checklistVersion=c,angular.forEach(r.selectedInspection.data[s.roomID].data,function(m){var e='rooms["'+s.roomID+'"].sections["'+m._id+'"]';o.$watch(e,function(e,t){angular.equals(e,t)||(r.selectedInspection.data[s.roomID].data[m._id]=e,r.saveVisitData(s.roomID,m._id,e),o.rooms[s.roomID].sections[m._id].markSectionComplete=!0)},!0)}),o.rooms[s.roomID].sections=r.selectedInspection.data[s.roomID].data}else e.info("In room controller but no inspection selected, should be redirected");o.$on("$ionicView.beforeEnter",function(){angular.equals(r.selectedVisit,{})&&t.go("home",{},{reload:!0}),d()}),o.$on("$ionicView.leave",function(){o.$destroy()}),o.rooms.markSectionNA=function(m){m.naChoice?m.naChoice=!1:(m.naChoice=!0,o.rooms.showSections.data||(o.rooms.showSections.data={}),o.rooms.showSections.data[s.roomID]="")},o.rooms.toggleSectionVisible=function(m){o.rooms.showSections.data||(o.rooms.showSections.data={}),o.rooms.showSections.data[s.roomID]===m._id?o.rooms.showSections.data[s.roomID]="":(o.rooms.showSections.data[s.roomID]=m._id,i.hash(m._id),n.anchorScroll())},o.rooms.videoError=function(o){e.error(o)},o.rooms.videoConfig={sources:[{}],tracks:[],theme:"lib/videogular-themes-default/videogular.css"};var l=function(m){o.rooms[s.roomID].modalSection=m},I=function(){var m=0;return angular.forEach(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos,function(o){m++}),m};o.rooms[s.roomID].videoFileNameChanged=function(m){var e=m.target;if(o.rooms[s.roomID].videoFilesItemHandle=e,1===e.files.length&&0===e.files[0].type.indexOf("video/")){var r=new FileReader;r.onload=function(m){var e=o.rooms[s.roomID].videoFilesItemHandle.files[0].name,r=o.rooms[s.roomID].videoFilesItemHandle.files[0].type;o.rooms[s.roomID].newVideos||(o.rooms[s.roomID].newVideos={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos={});var t={src:m.target.result,name:e,type:r};o.rooms[s.roomID].newVideos[o.rooms[s.roomID].modalSection].array=[t],o.$apply()},r.readAsDataURL(e.files[0])}},o.rooms[s.roomID].addNewVideo=function(){var m=angular.copy(o.rooms[s.roomID].newVideos[o.rooms[s.roomID].modalSection]);o.rooms[s.roomID].newVideos||(o.rooms[s.roomID].newVideos={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos={}),m._id=(new Date).getTime(),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos[m._id]=m,o.rooms[s.roomID].newVideos[o.rooms[s.roomID].modalSection]={},o.rooms[s.roomID].videoFilesItemHandle.value=""},o.rooms[s.roomID].deleteVideo=function(m){delete o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos[m],0===I()&&delete o.rooms[s.roomID][o.rooms[s.roomID].modalSection].videos};var D=function(){var m=0;return angular.forEach(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images,function(o){m++}),m};o.rooms[s.roomID].fileNameChanged=function(m){var e=m.target;if(o.rooms[s.roomID].filesItemHandle=e,1===e.files.length&&0===e.files[0].type.indexOf("image/")){var r=new FileReader;r.onload=function(m){a(function(){var e=o.rooms[s.roomID].filesItemHandle.files[0].name,r=o.rooms[s.roomID].filesItemHandle.files[0].type;o.rooms[s.roomID].newImages||(o.rooms[s.roomID].newImages={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images={}),o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection].src=m.target.result,o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection].name=e,o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection].type=r,o.rooms[s.roomID].addNewImage()})},r.readAsDataURL(e.files[0])}},o.rooms[s.roomID].addNewImage=function(){var m=angular.copy(o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection]);o.rooms[s.roomID].newImages||(o.rooms[s.roomID].newImages={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images={}),m._id=(new Date).getTime(),r.selectedVisit.data[s.roomID]||(r.selectedVisit.data[s.roomID]={data:{}}),r.selectedVisit.data[s.roomID].data[o.rooms[s.roomID].modalSection]||(r.selectedVisit.data[s.roomID].data[o.rooms[s.roomID].modalSection]={}),r.selectedVisit.data[s.roomID].data[o.rooms[s.roomID].modalSection].images||(r.selectedVisit.data[s.roomID].data[o.rooms[s.roomID].modalSection].images={}),r.selectedVisit.data[s.roomID].data[o.rooms[s.roomID].modalSection].images[m._id]=r.selectedVisit._id,r.saveAttachment(m,m.type).then(function(){if(o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].markSectionComplete=!0,o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].images)o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].images[m._id]=r.selectedVisit._id;else{var e={};e[m._id]=r.selectedVisit._id,o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].images=e}return r.selectedVisit._id}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images[m._id]=m,o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection]={},o.rooms[s.roomID].filesItemHandle.value=""},o.rooms[s.roomID].deleteImage=function(m){delete o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images[m],0===D()&&delete o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images};var S=function(){var m=0;return angular.forEach(o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments,function(o){m++}),m};o.rooms[s.roomID].deleteComment=function(m){delete o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments[m],0===S()&&delete o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments},o.rooms[s.roomID].createComment=function(){var m=angular.copy(o.rooms[s.roomID].newComments[o.rooms[s.roomID].modalSection]);o.rooms[s.roomID].comments||(o.rooms[s.roomID].comments={}),o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments||(o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments={}),m._id=(new Date).getTime(),o.rooms[s.roomID].sections[o.rooms[s.roomID].modalSection].comments[m._id]=m,o.rooms[s.roomID].newComments[o.rooms[s.roomID].modalSection]={}},m.fromTemplateUrl("templates/modals/manageComments.html",{scope:o,animation:"slide-in-up",focusFirstInput:!0}).then(function(m){o.rooms[s.roomID].commentsModal=m}),o.rooms[s.roomID].openCommentsModal=function(m){l(m),o.rooms[s.roomID].newComments[o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID].newComments[o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID].commentsModal.show()},m.fromTemplateUrl("templates/modals/manageVideos.html",{scope:o,animation:"slide-in-up"}).then(function(m){o.rooms[s.roomID].videosModal=m}),o.rooms[s.roomID].openVideosModal=function(m){l(m),o.rooms[s.roomID].newVideos[o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID].newVideos[o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].showDelete=!1,o.rooms[s.roomID].videosModal.show()},m.fromTemplateUrl("templates/modals/manageImages.html",{scope:o,animation:"slide-in-up"}).then(function(m){o.rooms[s.roomID].imagesModal=m}),o.rooms[s.roomID].openImagesModal=function(m){l(m),o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID].newImages[o.rooms[s.roomID].modalSection]={}),r.selectedInspection.data[s.roomID]&&r.selectedInspection.data[s.roomID].data[o.rooms[s.roomID].modalSection]&&angular.forEach(r.selectedInspection.data[s.roomID].data[o.rooms[s.roomID].modalSection].images,function(m,t){r.getAttachment(m,t).then(function(m){return window.blobUtil.blobToBase64String(m).then(function(e){var r="data:"+m.type+";base64,"+e,i={_id:t,src:r};o.rooms[s.roomID][o.rooms[s.roomID].modalSection]||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection]={}),o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images||(o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images={}),a(function(){return o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images[t]=i,i})})})["catch"](function(o){e.error(o)})}),o.rooms[s.roomID].imagesModal.show()},o.$on("modal.hidden",function(m){e.info("Closing one of the modals"),o.rooms[s.roomID]&&o.rooms[s.roomID].modalSection&&o.rooms[s.roomID][o.rooms[s.roomID].modalSection]&&delete o.rooms[s.roomID][o.rooms[s.roomID].modalSection].images}),o.$on("$destroy",function(){e.info("Destroying all modals"),o.rooms[s.roomID].imagesModal.remove(),o.rooms[s.roomID].videosModal.remove(),o.rooms[s.roomID].commentsModal.remove()})};d()}]);