"use strict";angular.module("app.controllers").controller("roomsCtrl",["$scope","$ionicModal","$log","localDataFactory","$stateParams","$state",function(o,e,m,s,r,n){var i=function(){if(o.rooms={},o.rooms.showSections=s.showSections,o.rooms.selectedRoomID=r.roomID,o.rooms[r.roomID]={},o.rooms[r.roomID].newComments={},o.rooms[r.roomID].newImages={},o.rooms[r.roomID].newVideos={},o.rooms[r.roomID].modalSection="",o.rooms[r.roomID].checklistVersion="loading",o.rooms[r.roomID].showTips={},o.rooms.inspectionWorkTrackingConditions={},o.rooms.typesConditions={},o.rooms.trades={},o.rooms.showTrade="Electrical",s.selectedVisit._id?o.rooms.displayTitle=s.selectedVisit._id:o.rooms.displayTitle="",s.selectedInspectionID){o.rooms[r.roomID].selectedPropertyName=s.selectedInspection.propertyName,o.rooms.displayTitle=s.selectedVisit._id,s.selectedInspection.inspectionWorkTrackingConditions&&(o.rooms.inspectionWorkTrackingConditions=s.selectedInspection.inspectionWorkTrackingConditions),s.selectedInspection.typesConditions&&(o.rooms.typesConditions=s.selectedInspection.typesConditions),s.selectedInspection.trades&&(o.rooms.trades=s.selectedInspection.trades);var e=s.selectedInspection.checklistVersion;e||(e="v1"),o.rooms[r.roomID].checklistVersion=e,angular.forEach(s.selectedInspection.data[r.roomID].data,function(e){e.markSectionComplete&&(o.rooms.showSections.data[r.roomID]||(o.rooms.showSections.data[r.roomID]={}),o.rooms.showSections.data[r.roomID][e._id]=!0);var m='rooms["'+r.roomID+'"].sections["'+e._id+'"]';o.$watch(m,function(o,m){angular.equals(o,m)||(s.selectedInspection.data[r.roomID].data[e._id]=o,s.saveVisitData(r.roomID,e._id,o))},!0)}),o.rooms[r.roomID].sections=s.selectedInspection.data[r.roomID].data}else m.info("In room controller but no inspection selected, should be redirected")};i(),o.$on("$ionicView.beforeEnter",function(){angular.equals(s.selectedVisit,{})&&n.go("home",{},{reload:!0}),i()}),o.$on("$ionicView.leave",function(){o.$destroy()}),o.rooms.markSectionNA=function(e){e.naChoice="N/A",o.rooms[o.rooms.selectedRoomID][e._id]=!1},o.rooms.videoError=function(o){m.error(o)},o.rooms.videoConfig={sources:[{}],tracks:[],theme:"lib/videogular-themes-default/videogular.css"};var t=function(e){o.rooms[r.roomID].modalSection=e},a=function(){var e=0;return angular.forEach(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos,function(o){e++}),e};o.rooms[r.roomID].videoFileNameChanged=function(e){var m=e.target;if(o.rooms[r.roomID].videoFilesItemHandle=m,1===m.files.length&&0===m.files[0].type.indexOf("video/")){var s=new FileReader;s.onload=function(e){var m=o.rooms[r.roomID].videoFilesItemHandle.files[0].name,s=o.rooms[r.roomID].videoFilesItemHandle.files[0].type;o.rooms[r.roomID].newVideos||(o.rooms[r.roomID].newVideos={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos||(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos={});var n={src:e.target.result,name:m,type:s};o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection].array=[n],o.$apply()},s.readAsDataURL(m.files[0])}},o.rooms[r.roomID].addNewVideo=function(){var e=angular.copy(o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]);o.rooms[r.roomID].newVideos||(o.rooms[r.roomID].newVideos={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos||(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos={}),e._id=a()+1,o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos[e._id]=e,o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]={},o.rooms[r.roomID].videoFilesItemHandle.value=""},o.rooms[r.roomID].deleteVideo=function(e){delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos[e],0===a()&&delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].videos};var d=function(){var e=0;return angular.forEach(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images,function(o){e++}),e};o.rooms[r.roomID].fileNameChanged=function(e){var m=e.target;if(o.rooms[r.roomID].filesItemHandle=m,1===m.files.length&&0===m.files[0].type.indexOf("image/")){var s=new FileReader;s.onload=function(e){var m=o.rooms[r.roomID].filesItemHandle.files[0].name;o.rooms[r.roomID].newImages||(o.rooms[r.roomID].newImages={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images||(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images={}),o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection].src=e.target.result,o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection].name=m,o.$apply()},s.readAsDataURL(m.files[0])}},o.rooms[r.roomID].addNewImage=function(){var e=angular.copy(o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]);o.rooms[r.roomID].newImages||(o.rooms[r.roomID].newImages={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images||(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images={}),e._id=d()+1,o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images[e._id]=e,o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]={},o.rooms[r.roomID].filesItemHandle.value=""},o.rooms[r.roomID].deleteImage=function(e){delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images[e],0===d()&&delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].images};var c=function(){var e=0;return angular.forEach(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments,function(o){e++}),e};o.rooms[r.roomID].deleteComment=function(e){delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments[e],0===c()&&delete o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments},o.rooms[r.roomID].createComment=function(){var e=angular.copy(o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]);o.rooms[r.roomID].comments||(o.rooms[r.roomID].comments={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments||(o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments={}),e._id=c()+1,o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].comments[e._id]=e,o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]={}},e.fromTemplateUrl("templates/modals/manageComments.html",{scope:o,animation:"slide-in-up",focusFirstInput:!0}).then(function(e){o.rooms[r.roomID].commentsModal=e}),o.rooms[r.roomID].openCommentsModal=function(e){t(e),o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newComments[o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID].commentsModal.show()},o.rooms[r.roomID].closeCommentsModal=function(){o.rooms[r.roomID].commentsModal.hide()},o.$on("$destroy",function(){o.rooms[r.roomID].commentsModal.remove()}),e.fromTemplateUrl("templates/modals/manageVideos.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.rooms[r.roomID].videosModal=e}),o.rooms[r.roomID].openVideosModal=function(e){t(e),o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newVideos[o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID].sections[o.rooms[r.roomID].modalSection].showDelete=!1,o.rooms[r.roomID].videosModal.show()},o.rooms[r.roomID].closeVideosModal=function(){o.rooms[r.roomID].videosModal.hide()},o.$on("$destroy",function(){o.rooms[r.roomID].videosModal.remove()}),e.fromTemplateUrl("templates/modals/manageImages.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.rooms[r.roomID].imagesModal=e}),o.rooms[r.roomID].openImagesModal=function(e){t(e),o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]||(o.rooms[r.roomID].newImages[o.rooms[r.roomID].modalSection]={}),o.rooms[r.roomID].imagesModal.show()},o.rooms[r.roomID].closeImagesModal=function(){o.rooms[r.roomID].imagesModal.hide()},o.$on("$destroy",function(){o.rooms[r.roomID].imagesModal.remove()})}]);