"use strict";angular.module("app.services").factory("localDataFactory",["$pouchDB","$q","$log","ImportFactory",function(e,t,n,i){var a={},s="https://mymarsi.cloudant.com/marsi-test-open-access";a.currentPerson={_id:"Default",name:"Default"},a.isReady=!1,a.processingPromise=null,a.selectedInspectionID=null,a.selectedInspection={},a.allInspectionIDs={},a.allUnits={},a.selectedVisit={},a.selectedTemplate={},e.setDatabase("mymarsi-demo-visits"),e.sync(s),a.removeTemplateSectionFromVisit=function(e,t){var n=a.selectedVisit.data[e].data[t],i=a.selectedTemplate.data[e].data[t];angular.forEach(n,function(e,t){angular.equals(e,i[t])&&delete n[t]}),angular.forEach(n.typesConditions,function(e,t){angular.equals(e,i.typesConditions[t])&&delete n.typesConditions[t]})},a.getAllUnits=function(){var t="getUnits/all-units-by-id";return e.query(t,!0).then(function(e){a.allUnits={},angular.forEach(e.rows,function(e){var t=e.doc;a.allUnits[t._id]=t})})},a.getQueryStubs=function(i,a){var s=t.defer();return e.query(a,!1,i).then(function(e){var t={};angular.forEach(e.rows,function(e){t[e.id]={_id:e.id,name:e.value}}),s.resolve(t)})["catch"](function(e){n.error(e),s.reject(e)}),s.promise},a.getAllDocumentIDs=function(){return e.getAll(!1).then(function(e){e.rows.length&&(a.allInspectionIDs={},angular.forEach(e.rows,function(e){a.allInspectionIDs[e.id]={_id:e.id}}))})};var c=function(e){n.error(e),a.selectedInspectionID=null,a.isReady=!1,a.processingPromise.reject(e)};return a.getInspectionData=function(i){return i===a.selectedInspectionID?a.isReady?t.when(a.selectedInspection):a.processingPromise.promise:(a.isReady=!1,a.processingPromise=t.defer(),a.selectedInspection={},a.selectedInspectionID=i,e.get({ok:!0,id:i}).then(function(t){n.info("Success getting sections from local db"),t.templateID?e.get({ok:!0,id:t.templateID}).then(function(n){a.selectedInspection=n,a.selectedTemplate=angular.copy(n),angular.merge(a.selectedInspection,t);var s="getInspectionVisits/visit-data-by-inspection-id";e.query(s,!0,i).then(function(e){angular.forEach(e.rows,function(e){angular.merge(a.selectedInspection.data,e.doc.data)}),a.isReady=!0,a.processingPromise.resolve(a.selectedInspection)})["catch"](c)})["catch"](c):c("No inspection template")})["catch"](c),a.processingPromise.promise)},a.getVisitData=function(i){var a=t.defer();return e.get({ok:!0,id:i}).then(function(e){a.resolve(e)})["catch"](function(e){n.error(e),a.reject(e)}),a.promise},a.createNewVisit=function(e,t){var n=t._id,i=new Date,s=i.getTime(),c=i.toString(),o="Visit "+c,r=e+"/"+t.name+"/"+o;angular.extend(a.selectedVisit,{_id:r,createdAt:s,name:o,type:"Visit",inspectionID:n,userID:a.currentPerson._id,userName:a.currentPerson.name,data:{}})},a.saveVisitData=function(e,t,n){a.selectedVisit.data[e]||(a.selectedVisit.data[e]={}),a.selectedVisit.data[e].data||(a.selectedVisit.data[e].data={}),a.selectedVisit.data[e].data[t]=angular.copy(n),a.removeTemplateSectionFromVisit(e,t),a.selectedVisit.data[e].data[t].markSectionComplete=!0,a.saveData(a.selectedVisit)},a.saveData=function(t){e.save(t).then(function(){n.info("Success saving change to db")})["catch"](function(i){409===i.status?e.retryUntilWritten(t):n.error(i)})},a.syncData=function(){return t.resolve(!0)},a}]);