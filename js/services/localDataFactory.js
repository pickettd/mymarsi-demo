"use strict";angular.module("app.services").factory("localDataFactory",["$pouchDB","$q","$log","ImportFactory","$ionicPlatform","$timeout","dropbox",function(e,t,n,i,a,c,o){function r(){e.sync(d).on("change",function(e){"pull"===e.direction&&(o.hasToken||o.getToken(),u.activeSync.state=!0,n.info("Got new data from cloudant so replacing all unit structure"),u.getAllUnits().then(function(){u.activeSync.state=!1}))}).on("paused",function(e){o.hasToken||o.getToken(),n.info("Cloud changes sync is waiting for new data"),u.getAllUnits().then(function(){u.activeSync.state=!1})}).on("active",function(){o.hasToken||o.getToken(),u.activeSync.state=!0,n.info("Cloud changes sync is actively exchanging new data")}).on("denied",function(e){o.hasToken||o.getToken(),n.error("a document failed to replicate (e.g. due to permissions)"),n.error(e),u.getAllUnits(),u.activeSync.state=!1}).on("complete",function(e){o.hasToken||o.getToken(),n.info("sync complete"),u.getAllUnits().then(function(){u.activeSync.state=!1})}).on("error",function(e){o.hasToken||o.getToken(),n.error("sync error"),n.error(e),u.getAllUnits(),u.activeSync.state=!1}),o.getToken()}function s(){c(function(){r(d)},3e5).then(function(){s()})}var u={},d="https://mymarsi.cloudant.com/marsi-real-world-v4";u.currentPerson={_id:"Kim",name:"Kim"},u.isReady=!1,u.processingPromise=null,u.selectedInspectionID=null,u.selectedInspection={},u.allInspectionIDs={},u.allUnits={data:{}},u.selectedVisit={},u.selectedTemplate={},u.showSections={data:{}},u.activeSync={state:!0},u.withoutTemplate=void 0,u.getAttachment=e.getAttachment,u.createDoc=e.createDoc,u.currentInspectionTemplateOptions=i.currentInspectionTemplateOptions;var l=function(){n.info("Device should be ready, setting up database"),e.setDatabase("marsi-real-world-v4"),u.activeSync.state=!1,r(),s()};u.removeTemplateSectionFromVisit=function(e,t){var n=u.selectedVisit.data[e].data[t],i=u.selectedTemplate.data[e].data[t];angular.forEach(n,function(e,t){angular.equals(e,i[t])&&delete n[t]}),angular.forEach(n.typesConditions,function(e,t){angular.equals(e,i.typesConditions[t])&&delete n.typesConditions[t]})},u.getAllUnits=function(){var t="getUnits/all-units-by-id";return e.query(t,!0).then(function(e){u.allUnits.data={},angular.forEach(e.rows,function(e){var t=e.doc;u.allUnits.data[t._id]=t})})},u.getQueryStubs=function(i,a){var c=t.defer();return e.query(a,!1,i).then(function(e){var t={};angular.forEach(e.rows,function(e){t[e.id]={_id:e.id,name:e.value}}),c.resolve(t)})["catch"](function(e){n.error(e),c.reject(e)}),c.promise},u.getAllDocumentIDs=function(){return e.getAll(!1).then(function(e){e.rows.length&&(u.allInspectionIDs={},angular.forEach(e.rows,function(e){u.allInspectionIDs[e.id]={_id:e.id}}))})};var p=function(e){n.error(e),u.selectedInspectionID=null,u.isReady=!1,u.processingPromise.reject(e)};u.getInspectionData=function(i,a){if(i===u.selectedInspectionID&&u.withoutTemplate===a)return u.isReady?t.when(u.selectedInspection):u.processingPromise.promise;u.withoutTemplate=a,u.isReady=!1,u.processingPromise=t.defer();var c=[];return u.selectedInspection={},u.selectedInspectionID=i,e.get({ok:!0,id:i}).then(function(o){return n.info("Success getting sections from local db"),o.templateID?(e.get({ok:!0,id:o.templateID}).then(function(n){a?u.selectedInspection={data:{}}:u.selectedInspection=n,u.selectedTemplate=angular.copy(n),angular.merge(u.selectedInspection,o);var r="getInspectionVisits/visit-data-by-inspection-id";return e.query(r,!0,i).then(function(n){return angular.forEach(n.rows,function(t){angular.merge(u.selectedInspection.data,t.doc.data);var n="getInspectionVisitDatas/visit-datas-by-visit-id",i=e.query(n,!0,t.doc._id).then(function(e){return angular.forEach(e.rows,function(e){angular.merge(u.selectedInspection.data,e.doc.data)}),!0});c.push(i)}),t.all(c).then(function(){return u.isReady=!0,u.showSections.data={},u.processingPromise.resolve(u.selectedInspection),!0})})["catch"](p),!0})["catch"](p),!0):void p("No inspection template")})["catch"](p),u.processingPromise.promise},u.getVisitData=function(i){var a=t.defer();return e.get({ok:!0,id:i}).then(function(e){a.resolve(e)})["catch"](function(e){n.error(e),a.reject(e)}),a.promise},u.createNewVisit=function(e,t){var n=t._id,i=new Date,a=i.getTime(),c=i.toString(),o=e.name+"/"+t.name+"/Visit "+c,r=n+"/Visit "+c;return angular.extend(u.selectedVisit,{_id:r,createdAt:a,name:o,type:"Visit",inspectionID:n,userID:u.currentPerson._id,userName:u.currentPerson.name,data:{}}),u.getInspectionData(t._id)},u.saveVisitDataByProperties=function(e,t,n){var i=(new Date).getTime(),a={_id:u.selectedVisit._id+"/"+t._id+i,type:"VisitData",visitID:u.selectedVisit._id,data:{}};a.data[e]={data:{}},a.data[e].data[t._id]={},angular.merge(a.data[e].data[t._id],n),t.markSectionComplete||(a.data[e].data[t._id].markSectionComplete=!0);var c={_id:u.selectedVisit._id,type:u.selectedVisit.type,inspectionID:u.selectedVisit.inspectionID,userID:u.selectedVisit.userID,userName:u.selectedVisit.userName,data:{}};u.createDoc(c),u.saveData(a)},u.saveVisitData=function(e,t,n){return u.selectedVisit.data[e]||(u.selectedVisit.data[e]={}),u.selectedVisit.data[e].data||(u.selectedVisit.data[e].data={}),u.selectedVisit.data[e].data[t]=angular.copy(n),u.removeTemplateSectionFromVisit(e,t),u.selectedVisit.data[e].data[t].markSectionComplete=!0,u.saveData(u.selectedVisit)},u.saveData=function(t){return e.save(t).then(function(){n.info("Success saving change to db")})["catch"](function(i){409===i.status?e.retryUntilWritten(t):n.error(i)})};var f=function(t){return e.get({ok:!0,id:u.selectedVisit._id}).then(function(e){return e._attachments?(u.selectedVisit._attachments=e._attachments,e._attachments):void 0})};return u.saveAttachment=function(t,i){return window.blobUtil.dataURLToBlob(t.src).then(function(a){return e.get({ok:!0,id:u.selectedVisit._id}).then(function(n){return e.putAttachment(n._id,t._id,n._rev,a,i).then(f)})["catch"](function(c){if(404===c.status)return e.save(u.selectedVisit).then(function(n){return e.putAttachment(u.selectedVisit._id,t._id,n.rev,a,i).then(f)});throw n.error(c),c})}).then(function(){return n.info("Success saving attachment to db"),1})["catch"](function(e){n.error(e)})},u.createNewUnit=function(t){var i=t.name.trim().toUpperCase();return e.get({ok:!0,id:i}).then(function(e){return n.error("Tried to create new unit with non-unique name"),e})["catch"](function(a){if(404===a.status){var c={_id:i,name:t.name,type:"Unit",unitTemplate:t.unitTemplate};return e.save(c).then(function(){return n.info("Created new unit, so replacing all unit structure"),u.getAllUnits(),i})["catch"](function(e){n.error(e)})}n.error(a)})},u.createNewInspection=function(t,a){var c={_id:t._id+"/Inspection "+(new Date).getTime(),propertyID:t._id,propertyName:t.name,name:a,type:"Inspection",checklistVersion:i.currentChecklistDisplayVersion,templateID:t.unitTemplate._id};return e.save(c).then(function(){n.info("Created new inspection")})["catch"](function(e){n.error(e)})},u.syncData=function(){r()},window.localStorage.ionicView?a.ready(l):c(l,0),u}]);