"use strict";angular.module("app.services").factory("localDataFactory",["$pouchDB","$q","$log","ImportFactory",function(e,t,n,a){var i={},s="https://mymarsi.cloudant.com/marsi-test-open-access";i.currentPerson={_id:"Default",name:"Default"},i.isReady=!1,i.processingPromise=null,i.selectedInspectionID=null,i.selectedInspection={},i.allInspectionIDs={},i.allUnits={data:{}},i.selectedVisit={},i.selectedTemplate={},e.setDatabase("mymarsi-demo-visits"),e.sync(s).on("change",function(e){"pull"===e.direction&&angular.equals(i.selectedVisit,{})&&i.getAllUnits()}),i.removeTemplateSectionFromVisit=function(e,t){var n=i.selectedVisit.data[e].data[t],a=i.selectedTemplate.data[e].data[t];angular.forEach(n,function(e,t){angular.equals(e,a[t])&&delete n[t]}),angular.forEach(n.typesConditions,function(e,t){angular.equals(e,a.typesConditions[t])&&delete n.typesConditions[t]})},i.getAllUnits=function(){var t="getUnits/all-units-by-id";return e.query(t,!0).then(function(e){i.allUnits.data={},angular.forEach(e.rows,function(e){var t=e.doc;i.allUnits.data[t._id]=t})})},i.getQueryStubs=function(a,i){var s=t.defer();return e.query(i,!1,a).then(function(e){var t={};angular.forEach(e.rows,function(e){t[e.id]={_id:e.id,name:e.value}}),s.resolve(t)})["catch"](function(e){n.error(e),s.reject(e)}),s.promise},i.getAllDocumentIDs=function(){return e.getAll(!1).then(function(e){e.rows.length&&(i.allInspectionIDs={},angular.forEach(e.rows,function(e){i.allInspectionIDs[e.id]={_id:e.id}}))})};var c=function(e){n.error(e),i.selectedInspectionID=null,i.isReady=!1,i.processingPromise.reject(e)};return i.getInspectionData=function(a){return a===i.selectedInspectionID?i.isReady?t.when(i.selectedInspection):i.processingPromise.promise:(i.isReady=!1,i.processingPromise=t.defer(),i.selectedInspection={},i.selectedInspectionID=a,e.get({ok:!0,id:a}).then(function(t){n.info("Success getting sections from local db"),t.templateID?e.get({ok:!0,id:t.templateID}).then(function(n){i.selectedInspection=n,i.selectedTemplate=angular.copy(n),angular.merge(i.selectedInspection,t);var s="getInspectionVisits/visit-data-by-inspection-id";e.query(s,!0,a).then(function(e){angular.forEach(e.rows,function(e){angular.merge(i.selectedInspection.data,e.doc.data)}),i.isReady=!0,i.processingPromise.resolve(i.selectedInspection)})["catch"](c)})["catch"](c):c("No inspection template")})["catch"](c),i.processingPromise.promise)},i.getVisitData=function(a){var i=t.defer();return e.get({ok:!0,id:a}).then(function(e){i.resolve(e)})["catch"](function(e){n.error(e),i.reject(e)}),i.promise},i.createNewVisit=function(e,t){var n=t._id,a=new Date,s=a.getTime(),c=a.toString(),o="Visit "+c,r=e+"/"+t.name+"/"+o;angular.extend(i.selectedVisit,{_id:r,createdAt:s,name:o,type:"Visit",inspectionID:n,userID:i.currentPerson._id,userName:i.currentPerson.name,data:{}})},i.saveVisitData=function(e,t,n){i.selectedVisit.data[e]||(i.selectedVisit.data[e]={}),i.selectedVisit.data[e].data||(i.selectedVisit.data[e].data={}),i.selectedVisit.data[e].data[t]=angular.copy(n),i.removeTemplateSectionFromVisit(e,t),i.selectedVisit.data[e].data[t].markSectionComplete=!0,i.saveData(i.selectedVisit)},i.saveData=function(t){e.save(t).then(function(){n.info("Success saving change to db")})["catch"](function(a){409===a.status?e.retryUntilWritten(t):n.error(a)})},i.syncData=function(){return t.resolve(!0)},i}]);