"use strict";angular.module("app.services").factory("localDataFactory",["$pouchDB","$q","$log","ImportFactory","$ionicPlatform","$timeout",function(t,e,n,i,a,s){var c={},o="https://mymarsi.cloudant.com/marsi-real-world-v3";c.currentPerson={_id:"Kim",name:"Kim"},c.isReady=!1,c.processingPromise=null,c.selectedInspectionID=null,c.selectedInspection={},c.allInspectionIDs={},c.allUnits={data:{}},c.selectedVisit={},c.selectedTemplate={},c.showSections={data:{}},c.activeSync={state:!0},c.withoutTemplate=void 0,c.getAttachment=t.getAttachment;var r=function(){n.info("Device should be ready, setting up database"),t.setDatabase("mymarsi-beta-visits-v2-1"),c.activeSync.state=!1,t.sync(o).on("change",function(t){"pull"===t.direction&&(n.info("Got new data from cloudant so replacing all unit structure"),c.getAllUnits())}).on("paused",function(t){n.info("Cloud changes sync is waiting for new data"),c.getAllUnits()}).on("active",function(){c.activeSync.state=!0,n.info("Cloud changes sync is actively exchanging new data")})};c.removeTemplateSectionFromVisit=function(t,e){var n=c.selectedVisit.data[t].data[e],i=c.selectedTemplate.data[t].data[e];angular.forEach(n,function(t,e){angular.equals(t,i[e])&&delete n[e]}),angular.forEach(n.typesConditions,function(t,e){angular.equals(t,i.typesConditions[e])&&delete n.typesConditions[e]})},c.getAllUnits=function(){var e="getUnits/all-units-by-id";return t.query(e,!0).then(function(t){c.allUnits.data={},angular.forEach(t.rows,function(t){var e=t.doc;c.allUnits.data[e._id]=e}),c.activeSync.state=!1})},c.getQueryStubs=function(i,a){var s=e.defer();return t.query(a,!1,i).then(function(t){var e={};angular.forEach(t.rows,function(t){e[t.id]={_id:t.id,name:t.value}}),s.resolve(e)})["catch"](function(t){n.error(t),s.reject(t)}),s.promise},c.getAllDocumentIDs=function(){return t.getAll(!1).then(function(t){t.rows.length&&(c.allInspectionIDs={},angular.forEach(t.rows,function(t){c.allInspectionIDs[t.id]={_id:t.id}}))})};var l=function(t){n.error(t),c.selectedInspectionID=null,c.isReady=!1,c.processingPromise.reject(t)};return c.getInspectionData=function(i,a){return i===c.selectedInspectionID&&c.withoutTemplate===a?c.isReady?e.when(c.selectedInspection):c.processingPromise.promise:(c.withoutTemplate=a,c.isReady=!1,c.processingPromise=e.defer(),c.selectedInspection={},c.selectedInspectionID=i,t.get({ok:!0,id:i}).then(function(e){n.info("Success getting sections from local db"),e.templateID?t.get({ok:!0,id:e.templateID}).then(function(n){a?c.selectedInspection={data:{}}:c.selectedInspection=n,c.selectedTemplate=angular.copy(n),angular.merge(c.selectedInspection,e);var s="getInspectionVisits/visit-data-by-inspection-id";t.query(s,!0,i).then(function(t){angular.forEach(t.rows,function(t){angular.merge(c.selectedInspection.data,t.doc.data)}),c.isReady=!0,c.showSections.data={},c.processingPromise.resolve(c.selectedInspection)})["catch"](l)})["catch"](l):l("No inspection template")})["catch"](l),c.processingPromise.promise)},c.getVisitData=function(i){var a=e.defer();return t.get({ok:!0,id:i}).then(function(t){a.resolve(t)})["catch"](function(t){n.error(t),a.reject(t)}),a.promise},c.createNewVisit=function(t,e){var n=e._id,i=new Date,a=i.getTime(),s=i.toString(),o="Visit "+s,r=t+"/"+e.name+"/"+o;return angular.extend(c.selectedVisit,{_id:r,createdAt:a,name:o,type:"Visit",inspectionID:n,userID:c.currentPerson._id,userName:c.currentPerson.name,data:{}}),c.getInspectionData(e._id)},c.saveVisitData=function(t,e,n){c.selectedVisit.data[t]||(c.selectedVisit.data[t]={}),c.selectedVisit.data[t].data||(c.selectedVisit.data[t].data={}),c.selectedVisit.data[t].data[e]=angular.copy(n),c.removeTemplateSectionFromVisit(t,e),c.selectedVisit.data[t].data[e].markSectionComplete=!0,c.saveData(c.selectedVisit)},c.saveData=function(e){t.save(e).then(function(){n.info("Success saving change to db")})["catch"](function(i){409===i.status?t.retryUntilWritten(e):n.error(i)})},c.saveAttachment=function(e,i){return window.blobUtil.dataURLToBlob(e.src).then(function(a){return t.get({ok:!0,id:c.selectedVisit._id}).then(function(n){return t.putAttachment(n._id,e._id,n._rev,a,i)})["catch"](function(s){return 404===s.status?t.save(c.selectedVisit).then(function(n){return t.putAttachment(c.selectedVisit._id,e._id,n.rev,a,i).then(function(e){return t.get({ok:!0,id:c.selectedVisit._id}).then(function(t){t._attachments&&(c.selectedVisit._attachments=t._attachments)})})}):void n.error(s)})}).then(function(){n.info("Success saving attachment to db")})["catch"](function(t){n.error(t)})},c.syncData=function(){return e.resolve(!0)},window.localStorage.ionicView?a.ready(r):s(r,0),c}]);